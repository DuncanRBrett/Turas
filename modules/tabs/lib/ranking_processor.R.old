# ==============================================================================
# MODULE 9: RANKING_PROCESSOR.R
# ==============================================================================
#
# PURPOSE:
#   Wrapper for Phase 6 ranking module integration with tabs system
#   Routes ranking questions to the Phase 6 ranking processor
#
# FUNCTIONS:
#   - process_ranking_question() - Main ranking processor wrapper
#
# DEPENDENCIES:
#   - utilities.R (safe operations, logging)
#   - Phase 6 ranking module (ranking.r)
#
# NOTE:
#   This module assumes Phase 6 ranking functions are available:
#   - extract_ranking_data()
#   - create_ranking_rows_for_item()
#
# VERSION: 1.0.0
# DATE: 2025-10-25
# ==============================================================================

# ==============================================================================
# MAIN RANKING PROCESSOR
# ==============================================================================

#' Process Ranking Question
#'
#' Wrapper function that routes ranking questions to Phase 6 ranking processor.
#' Extracts ranking data, builds banner data lists, and creates ranking rows.
#'
#' INTEGRATION: Uses Phase 6 ranking module functions
#'
#' @param data Data frame, survey data (filtered)
#' @param question_info Data frame row, question metadata
#' @param question_options Data frame, ranking items
#' @param banner_info List, banner structure
#' @param banner_row_indices List, row indices by column
#' @param master_weights Numeric vector, weights
#' @param banner_bases List, base sizes
#' @param config List, configuration
#' @param is_weighted Logical, weighting flag
#' @return Data frame with ranking results or NULL
#' @export
process_ranking_question <- function(data, question_info, question_options,
                                    banner_info, banner_row_indices,
                                    master_weights, banner_bases, config,
                                    is_weighted = FALSE) {
  
  question_code <- question_info$QuestionCode
  
  # Step 1: Extract ranking data using Phase 6 function
  ranking_data <- safe_execute(
    extract_ranking_data(data, question_info, question_options),
    default = NULL,
    error_msg = sprintf("Ranking data extraction failed: %s", question_code),
    silent = !config$verbose
  )
  
  if (is.null(ranking_data)) {
    warning(sprintf("Skipping %s: ranking data extraction failed", question_code))
    return(NULL)
  }
  
  # Step 2: Build banner data list and weights list
  # Phase 6 ranking functions require these structures
  banner_data_list <- list()
  weights_list <- list()
  
  for (key in banner_info$internal_keys) {
    row_idx <- banner_row_indices[[key]]
    
    if (length(row_idx) > 0) {
      subset_df <- data[row_idx, , drop = FALSE]
      subset_df$.original_row <- row_idx
      banner_data_list[[key]] <- subset_df
      weights_list[[key]] <- master_weights[row_idx]
    } else {
      banner_data_list[[key]] <- data[integer(0), , drop = FALSE]
      weights_list[[key]] <- numeric(0)
    }
  }
  
  # Step 3: Create rows for each ranking item using Phase 6 function
  question_results <- list()
  
  for (item in ranking_data$items) {
    item_rows <- safe_execute(
      create_ranking_rows_for_item(
        ranking_data$matrix, item, banner_data_list, banner_info,
        banner_info$internal_keys, weights_list,
        show_top_n = TRUE,
        top_n = 3,  # Show top 3 positions
        num_positions = ranking_data$num_positions,
        decimal_places_percent = config$decimal_places_percent,
        decimal_places_index = config$decimal_places_index
      ),
      default = NULL,
      error_msg = sprintf("Failed to create rows for item: %s", item),
      silent = !config$verbose
    )
    
    if (!is.null(item_rows)) {
      question_results <- c(question_results, item_rows)
    }
  }
  
  # Step 4: Combine all item rows
  if (length(question_results) > 0) {
    question_table <- batch_rbind(question_results)
    
    if (!is.null(question_table) && nrow(question_table) > 0) {
      log_message(
        sprintf("  -> %d ranking rows generated", nrow(question_table)),
        level = "DEBUG",
        verbose = config$verbose
      )
      return(question_table)
    }
  }
  
  # No results generated
  log_message(
    sprintf("  -> No ranking results for %s", question_code),
    level = "WARNING",
    verbose = config$verbose
  )
  
  return(NULL)
}

# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================

#' Check Ranking Module Availability
#'
#' Verifies that Phase 6 ranking functions are available.
#'
#' @return Logical, TRUE if ranking functions exist
#' @export
check_ranking_module <- function() {
  required_functions <- c(
    "extract_ranking_data",
    "create_ranking_rows_for_item"
  )
  
  missing <- character(0)
  for (func in required_functions) {
    if (!exists(func, mode = "function")) {
      missing <- c(missing, func)
    }
  }
  
  if (length(missing) > 0) {
    warning(sprintf(
      "Phase 6 ranking module incomplete. Missing functions: %s",
      paste(missing, collapse = ", ")
    ))
    return(FALSE)
  }
  
  return(TRUE)
}

# ==============================================================================
# MODULE INFO
# ==============================================================================

#' Get Ranking Processor Module Information
#'
#' Returns metadata about the ranking_processor module.
#'
#' @return List with module information
#' @export
get_ranking_processor_info <- function() {
  list(
    module = "ranking_processor",
    version = "1.0.0",
    date = "2025-10-25",
    description = "Ranking question processor (Phase 6 integration wrapper)",
    functions = c(
      "process_ranking_question",
      "check_ranking_module",
      "get_ranking_processor_info"
    ),
    dependencies = c(
      "utilities.R",
      "Phase 6 ranking module"
    ),
    notes = "Requires Phase 6 ranking.r to be sourced"
  )
}

# ==============================================================================
# MODULE LOAD MESSAGE
# ==============================================================================

message("[OK] Turas>Tabs ranking_processor module loaded")

# Check if Phase 6 ranking module is available
if (!check_ranking_module()) {
  warning("Phase 6 ranking module not found - ranking questions will fail")
}

# ==============================================================================
# END OF MODULE 9: RANKING_PROCESSOR.R
# ==============================================================================
