# SHINY APP UPDATE - Add Data Headers Download

## Quick Integration

Add these snippets to your `shiny_app.R` file:

---

## 1. UI Section - Add Download Button

Find the download buttons section (probably near "Download Survey Structure") and add:

```r
# In your UI definition, add this button:

downloadButton(
  "download_headers",
  "Download Data Headers",
  class = "btn-success",
  style = "margin-top: 10px;"
)
```

**Or as a full action button group:**

```r
# If you have a button group for downloads:

div(
  style = "margin-top: 20px;",
  downloadButton("download_structure", "Download Survey Structure", class = "btn-primary"),
  downloadButton("download_selection", "Download Selection Sheet", class = "btn-info"),
  downloadButton("download_headers", "Download Data Headers", class = "btn-success")
)
```

---

## 2. Server Section - Add Download Handler

In your server function, add:

```r
# Add this download handler:

output$download_headers <- downloadHandler(
  filename = function() {
    "Data_Headers.xlsx"
  },
  content = function(file) {
    req(parsed_questions())
    
    # Show progress
    showNotification(
      "Generating Data_Headers.xlsx...",
      type = "message",
      duration = 3
    )
    
    # Generate the file
    tryCatch({
      generate_data_headers(parsed_questions(), file)
      
      showNotification(
        "Data_Headers.xlsx generated successfully!",
        type = "message",
        duration = 5
      )
    }, error = function(e) {
      showNotification(
        paste("Error generating headers:", e$message),
        type = "error",
        duration = 10
      )
    })
  }
)
```

---

## 3. Full Example - Complete Download Section

Here's a complete example showing all three downloads:

```r
# ============================================================================
# UI: Download Buttons
# ============================================================================

fluidRow(
  column(12,
    h4("Download Files"),
    p("Generate and download the following files:"),
    
    # Survey Structure
    div(
      style = "margin-bottom: 10px;",
      downloadButton("download_structure", "Survey Structure", class = "btn-primary"),
      tags$small(" - Questions and options definitions", style = "margin-left: 10px;")
    ),
    
    # Selection Sheet
    div(
      style = "margin-bottom: 10px;",
      downloadButton("download_selection", "Selection Sheet", class = "btn-info"),
      tags$small(" - Crosstab configuration template", style = "margin-left: 10px;")
    ),
    
    # Data Headers (NEW!)
    div(
      style = "margin-bottom: 10px;",
      downloadButton("download_headers", "Data Headers", class = "btn-success"),
      tags$small(" - Column names for raw data file", style = "margin-left: 10px;")
    )
  )
)

# ============================================================================
# SERVER: Download Handlers
# ============================================================================

# Survey Structure
output$download_structure <- downloadHandler(
  filename = function() { "Survey_Structure.xlsx" },
  content = function(file) {
    req(parsed_questions())
    generate_survey_structure(parsed_questions(), file)
  }
)

# Selection Sheet
output$download_selection <- downloadHandler(
  filename = function() { "Selection_Sheet.xlsx" },
  content = function(file) {
    req(parsed_questions())
    generate_selection_sheet(parsed_questions(), file)
  }
)

# Data Headers (NEW!)
output$download_headers <- downloadHandler(
  filename = function() { "Data_Headers.xlsx" },
  content = function(file) {
    req(parsed_questions())
    generate_data_headers(parsed_questions(), file)
  }
)
```

---

## 4. Optional: Download All Button

If you want to add a "Download All" button that creates a ZIP:

```r
# UI
downloadButton("download_all", "Download All Files", class = "btn-warning")

# Server
output$download_all <- downloadHandler(
  filename = function() {
    paste0("Turas_Parser_Output_", format(Sys.Date(), "%Y%m%d"), ".zip")
  },
  content = function(file) {
    req(parsed_questions())
    
    # Create temp directory
    temp_dir <- tempdir()
    
    # Generate all three files
    structure_file <- file.path(temp_dir, "Survey_Structure.xlsx")
    selection_file <- file.path(temp_dir, "Selection_Sheet.xlsx")
    headers_file <- file.path(temp_dir, "Data_Headers.xlsx")
    
    generate_survey_structure(parsed_questions(), structure_file)
    generate_selection_sheet(parsed_questions(), selection_file)
    generate_data_headers(parsed_questions(), headers_file)
    
    # Create ZIP
    zip::zipr(
      zipfile = file,
      files = c(structure_file, selection_file, headers_file),
      recurse = FALSE
    )
  }
)
```

---

## 5. Help Text (Optional)

Add helpful descriptions for users:

```r
# In UI, add a help section:

helpText(
  strong("Data Headers File:"),
  "This file shows the exact column names your raw data file should have.",
  "Use it to create your data entry template or verify existing data structure."
)
```

---

## Testing Checklist

After adding the code:

1. [ ] Parser loads without errors
2. [ ] Upload a test questionnaire
3. [ ] Click "Parse Document"
4. [ ] Three download buttons appear
5. [ ] Click "Download Data Headers"
6. [ ] File downloads as `Data_Headers.xlsx`
7. [ ] Open file - contains single header row
8. [ ] Headers include: ID, Q01, Q02, Q10_1, Q10_2, etc.
9. [ ] Multi-mention shows individual columns
10. [ ] Other-text columns present (Q10_othertext)

---

## Button Styles Reference

```r
# Primary (blue) - Main action
class = "btn-primary"

# Info (light blue) - Secondary action
class = "btn-info"

# Success (green) - Positive action
class = "btn-success"

# Warning (orange) - Caution action
class = "btn-warning"

# Danger (red) - Destructive action
class = "btn-danger"
```

---

## Complete File Structure

After implementation, your Shiny app will generate:

```
ðŸ“ Downloads/
  â”œâ”€â”€ Survey_Structure.xlsx
  â”œâ”€â”€ Selection_Sheet.xlsx
  â””â”€â”€ Data_Headers.xlsx  â† NEW!
```

---

## Troubleshooting

**Error: "could not find function 'generate_data_headers'"**

Solution: Make sure output_generator.R v1.2.0 is loaded and the function is defined

**Error: "parsed_questions() not found"**

Solution: Check your reactive variable name - it might be `questions()` or `parsed_data()`

**Headers file is empty**

Solution: Check that parsed_questions() has data and question codes are set

---

## Summary

To add Data Headers download:

1. âœ“ Add download button to UI
2. âœ“ Add download handler to server
3. âœ“ Use `generate_data_headers()` function
4. âœ“ Test with sample questionnaire

That's it! Users now get three files instead of two.
