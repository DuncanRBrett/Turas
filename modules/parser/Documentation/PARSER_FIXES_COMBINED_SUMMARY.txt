# PARSER FIXES SUMMARY - Version 1.2.0

## Two Critical Fixes

### Fix #1: Multi-Mention Individual Codes + Other-Text
**File:** output_generator.R  
**Problem:** Multi-mention options all had same code (Q10), no othertext handling  
**Solution:** Creates Q10_1, Q10_2, etc. and auto-generates _othertext questions

### Fix #2: Type Detection Priority
**File:** type_detector.R  
**Problem:** Format hints (brackets vs parentheses) checked LAST  
**Solution:** Format hints now checked FIRST - most reliable indicator

---

## Fix #1: Output Generator Enhancements

### What It Does

**Multi-Mention Individual Codes:**
- OLD: All options use Q10
- NEW: Q10_1, Q10_2, Q10_3, Q10_4, Q10_5, Q10_6, Q10_7

**Other-Text Auto-Generation:**
- Detects "Other (specify)" options
- Creates Q10_othertext question automatically
- Sets ShowInOutput = "N" by default

### Example Output

**Questions Sheet:**
```
QuestionCode    | QuestionText                           | Variable_Type | Columns
Q10             | How do you keep track...               | Multi_Mention | 7
Q10_othertext   | How do you keep track... - Other       | Open_End      |
```

**Options Sheet:**
```
QuestionCode   | OptionText                  | ShowInOutput
Q10_1          | Memory                      | Y
Q10_2          | Internal store system       | Y
Q10_3          | Personal records            | Y
Q10_4          | We rely on CCS              | Y
Q10_5          | Other - (specify)           | Y
Q10_6          | Don't keep track            | Y
Q10_7          | Not sure                    | Y
Q10_othertext  | Open-ended text response    | N
```

---

## Fix #2: Type Detection

### What It Fixes

**Problem Example:**
- Q10 with [ ] brackets → Was detected as Single_Response ✗
- Q6 with ( ) parentheses → Was detected as Multi_Mention ✗

**Root Cause:**
Format hints were checked last, after text pattern matching

**Solution:**
Format hints now checked FIRST:
1. ✓ Check [ ] brackets = Multi_Mention
2. ✓ Check ( ) parentheses = Single_Response
3. Then check text patterns
4. Then check option count

### Detection Priority (New)

```
Priority 0: FORMAT HINTS ← MOST RELIABLE
  [ ] brackets → Multi_Mention
  ( ) parentheses → Single_Response

Priority 1: NUMERIC PATTERNS
  0-10 scale → NPS
  1-10 scale → Rating

Priority 2: TEXT PATTERNS
  "select all" → Multi_Mention
  "rank" → Ranking
  etc.

Priority 3: OPTION COUNT
  2-5 options → Single_Response
  12+ options → Multi_Mention
```

---

## Installation Instructions

### Step 1: Navigate to Parser Directory
```bash
cd /Users/duncan/Documents/Turas/modules/parser/lib
```

### Step 2: Backup Old Files
```bash
cp output_generator.R output_generator.R.backup
cp type_detector.R type_detector.R.backup
```

### Step 3: Replace Both Files
- Copy new `output_generator.R` to this location
- Copy new `type_detector.R` to this location

### Step 4: Test
```r
setwd("/Users/duncan/Documents/Turas")
source("modules/parser/run_parser.R")
run_parser()
```

---

## Testing Checklist

Upload a test questionnaire and verify:

### Type Detection
✓ Q10 with [ ] brackets → Multi_Mention (not Single_Response)
✓ Q6 with ( ) parentheses → Single_Response (not Multi_Mention)
✓ Console shows: `[Format hint: brackets] → Multi_Mention`

### Output Generation
✓ Q10 options show as Q10_1, Q10_2, Q10_3, etc. (not all Q10)
✓ Q10_othertext appears in Questions sheet
✓ Q10_othertext has ShowInOutput = "N"
✓ Console shows: `✓ Added othertext option: Q10_othertext`

---

## Console Output You Should See

```
Step 5: Post-processing...
Question Q10: 7 options, format: brackets
    [Format hint: brackets] → Multi_Mention

=== GENERATING SURVEY STRUCTURE ===
  → Multi-mention option: Q10_1 - Memory
  → Multi-mention option: Q10_2 - Internal store system
  ℹ Detected 'other specify' option: Other - (specify)
  ℹ Created othertext question: Q10_othertext
  ✓ Added othertext option: Q10_othertext (ShowInOutput = N)
```

---

## Impact Summary

**Both fixes are:**
- ✓ Non-breaking (won't affect existing files)
- ✓ Backwards compatible
- ✓ Follow TURAS conventions
- ✓ Improve accuracy and usability

**You can now:**
- ✓ Reliably detect Multi_Mention vs Single_Response
- ✓ Get individual codes for multi-mention options
- ✓ Automatically handle "other specify" responses
- ✓ Keep "other text" hidden by default (ShowInOutput = N)

---

## Files Modified

1. `/modules/parser/lib/output_generator.R` (v1.1.0)
2. `/modules/parser/lib/type_detector.R` (v1.2.0)

## Version

**Parser Module:** 1.2.0  
**Release Date:** October 31, 2025  
**Status:** Production Ready
