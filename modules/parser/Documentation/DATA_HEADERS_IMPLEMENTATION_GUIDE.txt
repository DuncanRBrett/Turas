# DATA HEADERS FILE - IMPLEMENTATION GUIDE

## Overview

The parser now generates **three** downloadable files:
1. **Survey_Structure.xlsx** - Question and option definitions
2. **Selection_Sheet.xlsx** - Crosstab configuration template
3. **Data_Headers.xlsx** - Column headers for raw data file (NEW!)

## What Data_Headers.xlsx Contains

A single row with all column names that should be in your raw data file:

```
ID | Q01 | Q02 | Q03 | Q04 | Q05 | Q06 | Q07 | Q08 | Q09 | Q10_1 | Q10_2 | Q10_3 | Q10_4 | Q10_5 | Q10_6 | Q10_7 | Q10_othertext | Q11 | ...
```

### Column Structure:

1. **ID** - Respondent identifier (always first)
2. **Single mention questions** - Q01, Q02, Q03, Q06, etc.
3. **Multi-mention questions** - Q10_1, Q10_2, Q10_3, etc. (individual columns)
4. **Other-text columns** - Q10_othertext, Q01_othertext, etc.

## How It Works

The `generate_data_headers()` function:

1. Starts with "ID" column
2. For each question in Questions sheet:
   - **Single_Response/Rating/NPS/Likert/Open_End/Numeric**: Add base code (Q01)
   - **Multi_Mention**: Add Q10_1, Q10_2, ..., Q10_N (based on Columns field)
   - **Any question with "other specify"**: Also add Q10_othertext
3. Creates Excel with just header row (no data)

## Example Output

**For this questionnaire:**
- Q01: Job title (Single, 11 options, has "Other - Write In")
- Q06: How recommend (Single, 11 options)
- Q10: Keep track (Multi, 7 options, has "Other - specify")

**Data_Headers.xlsx will contain:**
```
ID | Q01 | Q01_othertext | Q02 | Q03 | Q04 | Q05 | Q06 | Q07 | Q08 | Q09 | Q10_1 | Q10_2 | Q10_3 | Q10_4 | Q10_5 | Q10_6 | Q10_7 | Q10_othertext | Q11 | ...
```

## Integration with Shiny App

To add the third download button in the parser Shiny app, update `shiny_app.R`:

### Add Download Handler

```r
# Add this to your server function:

output$download_headers <- downloadHandler(
  filename = function() {
    "Data_Headers.xlsx"
  },
  content = function(file) {
    req(parsed_questions())
    generate_data_headers(parsed_questions(), file)
  }
)
```

### Add Download Button to UI

```r
# Add this button next to the other download buttons:

downloadButton("download_headers", "Download Data Headers", 
               class = "btn-success")
```

## User Workflow

1. **Upload questionnaire** to parser
2. **Review** parsed questions
3. **Download three files:**
   - Survey_Structure.xlsx
   - Selection_Sheet.xlsx
   - Data_Headers.xlsx ← NEW!
4. **Use Data_Headers.xlsx to:**
   - Create data entry template
   - Verify existing data structure
   - Check column names match exactly

## Benefits

### For Data Creation:
- Copy headers into Excel
- Users know exact column names
- No guessing about Q10 vs Q10_1, Q10_2

### For Data Verification:
- Compare data file headers with Data_Headers.xlsx
- Quickly identify missing or misnamed columns
- Ensure data structure matches Survey_Structure

### For Import:
- Column names must match exactly
- Data_Headers.xlsx is the authoritative reference
- Prevents "column not found" errors in crosstabs

## Technical Details

### Header Generation Logic

```r
headers <- c("ID")  # Always start with ID

for each question:
  if Multi_Mention:
    add Q10_1, Q10_2, Q10_3, ..., Q10_N
    if has "other specify":
      add Q10_othertext
  else:
    add Q01, Q02, Q03, etc.
    if has "other specify":
      add Q01_othertext
```

### Multi-Mention Column Count

The number of columns (Q10_1, Q10_2, etc.) is determined by:
1. The `Columns` field in Questions sheet (if set)
2. The number of options detected (if Columns is blank)

### Other-Text Detection

Automatically adds `_othertext` column when option text contains:
- "other.*specify"
- "other.*write"
- "write.*in"
- "please.*state"
- "please.*explain"

## File Format

- **Format**: Excel (.xlsx)
- **Sheet name**: "Headers"
- **Rows**: 1 (headers only)
- **Columns**: Variable (depends on questionnaire)
- **Frozen**: First row (headers)
- **Width**: 15 for all columns
- **Style**: Blue header with white text

## Console Output

When generating Data_Headers.xlsx, you'll see:

```
=== GENERATING DATA HEADERS ===
Questions to export: 69
  Added othertext column: Q01_othertext
  Added othertext column: Q10_othertext
Total columns: 85
  - ID column: 1
  - Question columns: 84
✓ Generated Data_Headers.xlsx
=== GENERATION COMPLETE ===
```

## Example Use Cases

### Use Case 1: Create Data Entry Template
1. Open Data_Headers.xlsx
2. Copy header row to new Excel file
3. Add respondent data below headers
4. Save as survey_data.xlsx

### Use Case 2: Verify Existing Data
1. Open your survey_data.xlsx
2. Open Data_Headers.xlsx
3. Compare column names
4. Fix any mismatches

### Use Case 3: Data Import Preparation
1. Check Data_Headers.xlsx
2. Ensure all columns present in raw data
3. Rename columns if needed to match exactly
4. Run crosstabs with confidence

## Testing

After implementation, test with:

1. **Simple questionnaire** (5-10 questions, all single mention)
   - Should see: ID, Q01, Q02, Q03, etc.

2. **Multi-mention questionnaire** (with Q10 having 7 options)
   - Should see: ID, ..., Q10_1, Q10_2, Q10_3, Q10_4, Q10_5, Q10_6, Q10_7, ...

3. **Other-text questionnaire** (Q01 has "Other - Write In")
   - Should see: ID, Q01, Q01_othertext, ...

4. **Combined** (multi-mention + other-text)
   - Should see: ID, ..., Q10_1, Q10_2, ..., Q10_7, Q10_othertext, ...

## Troubleshooting

**Problem:** Headers don't match data file

**Solution:** 
- Check if data uses Q10 vs Q10_1, Q10_2
- Verify othertext columns exist in data
- Ensure column order doesn't matter (TURAS looks by name)

**Problem:** Too many/few columns for multi-mention

**Solution:**
- Check Columns field in Questions sheet
- Update if needed
- Regenerate Data_Headers.xlsx

**Problem:** Missing othertext columns

**Solution:**
- Check if option text contains "specify", "write in", etc.
- Manually add to Questions sheet if needed
- Regenerate Data_Headers.xlsx

## Version Info

**Version:** 1.2.0  
**Function:** `generate_data_headers()`  
**File:** output_generator.R  
**Output:** Data_Headers.xlsx  
**Date:** October 31, 2025

---

## Summary

Data_Headers.xlsx provides:
✓ Single source of truth for column names
✓ Eliminates guessing about data structure
✓ Matches exactly with Survey_Structure
✓ Makes data preparation easier
✓ Prevents import errors

Users now get three files instead of two, making the entire workflow more robust!
