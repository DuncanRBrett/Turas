# PARSER IMPROVEMENTS - IMPLEMENTATION GUIDE
## Multi-Mention Individual Codes & Other-Text Handling

### What's New (Version 1.1.0)

1. **Multi-Mention Individual Codes**
   - Q10 with 7 options now creates: Q10_1, Q10_2, Q10_3, Q10_4, Q10_5, Q10_6, Q10_7
   - Each option gets its own question code in the Options sheet
   - Makes it clearer which column in your data corresponds to which option

2. **Automatic Other-Text Question Generation**
   - Detects "Other (specify)" / "Other - Write In" options
   - Creates separate _othertext questions (e.g., Q10_othertext, Q01_othertext)
   - Sets ShowInOutput = "N" by default (you can change to "Y" if needed)
   - Works for both single mention and multi-mention questions

---

## How to Install

**Replace the file:**
```bash
# Navigate to your Turas folder
cd /Users/duncan/Documents/Turas/modules/parser/lib

# Backup the old file (recommended)
cp output_generator.R output_generator.R.backup

# Replace with new version
# (copy the new output_generator.R file to this location)
```

**No other changes needed** - the parser will automatically use the new logic.

---

## What Changes in the Output

### Before (Old Version)

**Questions Sheet:**
- Q10 | How do you keep track... | Multi_Mention | 7

**Options Sheet:**
```
QuestionCode | OptionText                  | ShowInOutput
Q10          | Memory                      | Y
Q10          | Internal store system       | Y
Q10          | Personal records            | Y
Q10          | We rely on CCS              | Y
Q10          | Other - (specify)           | Y
Q10          | Don't keep track            | Y
Q10          | Not sure                    | Y
```

### After (New Version)

**Questions Sheet:**
- Q10 | How do you keep track... | Multi_Mention | 7
- Q10_othertext | How do you keep track... - Other (specify) | Open_End |

**Options Sheet:**
```
QuestionCode   | OptionText                  | ShowInOutput
Q10_1          | Memory                      | Y
Q10_2          | Internal store system       | Y
Q10_3          | Personal records            | Y
Q10_4          | We rely on CCS              | Y
Q10_5          | Other - (specify)           | Y
Q10_6          | Don't keep track            | Y
Q10_7          | Not sure                    | Y
Q10_othertext  | Open-ended text response    | N
```

---

## How It Works

### Multi-Mention Detection

The parser checks if Variable_Type = "Multi_Mention" and then:
1. Counts the number of columns (from the Columns field)
2. Creates Q10_1, Q10_2, ... Q10_N codes for each option
3. These codes match your data columns

### Other-Text Detection

The parser looks for these patterns in option text:
- "other.*specify" (e.g., "Other - (specify)")
- "other.*write" (e.g., "Other - Write In")
- "write.*in"
- "please.*state"
- "please.*explain"

When detected:
1. Creates Q10_othertext question in Questions sheet
2. Adds Q10_othertext row in Options sheet
3. Sets ShowInOutput = "N" by default
4. Sets Variable_Type = "Open_End"

---

## Your Data File Requirements

For the system to work properly, your Excel data file must have columns named:

**Multi-Mention Example (Q10 with 7 options):**
```
Q10_1 | Q10_2 | Q10_3 | Q10_4 | Q10_5 | Q10_6 | Q10_7 | Q10_othertext
  1   |   0   |   1   |   0   |   0   |   1   |   0   | "CCS system"
```

**Single Mention Example (Q01 with other):**
```
Q01 | Q01_othertext
 5  | "Jane Smith"
```

---

## Controlling the Number of Columns

The parser sets the Columns field based on:
1. What you specify in the document
2. The number of options detected

**You should verify** the Columns number in the output is correct:
- Q10 with 7 options should show Columns = 7
- If you want to show/hide specific columns, edit in the Excel file

---

## Showing/Hiding Other-Text in Output

**Default:** ShowInOutput = "N" (hidden)

**To show other-text responses:**
1. Open Survey_Structure.xlsx
2. Go to Options sheet
3. Find the row with Q10_othertext (or Q01_othertext)
4. Change ShowInOutput from "N" to "Y"
5. Save the file
6. Run crosstabs normally

---

## Testing the Changes

1. **Prepare a test questionnaire** with:
   - At least one multi-mention question (use [ ] brackets)
   - At least one "Other (specify)" option
   - At least one single mention question with "Other - Write In"

2. **Run the parser:**
   ```r
   setwd("/Users/duncan/Documents/Turas")
   source("modules/parser/run_parser.R")
   run_parser()
   ```

3. **Check the output:**
   - Questions sheet: Look for _othertext questions
   - Options sheet: Look for Q10_1, Q10_2, etc. codes
   - Options sheet: Look for _othertext rows with ShowInOutput = "N"

4. **Verify in console:**
   - Look for messages like:
     ```
     → Multi-mention option: Q10_1 - Memory
     ℹ Detected 'other specify' option: Other - (specify)
     ✓ Added othertext option: Q10_othertext (ShowInOutput = N)
     ```

---

## Troubleshooting

**Problem:** Multi-mention still shows Q10 instead of Q10_1, Q10_2, etc.

**Solution:** 
- Check that Variable_Type is "Multi_Mention" in the Questions sheet
- Verify the Columns field has a number (e.g., 7)
- Make sure you replaced the correct file

**Problem:** Other-text not created

**Solution:**
- Check your option text contains words like "specify", "write in", etc.
- The detection is case-insensitive
- Try adding "- (specify)" to the option text

**Problem:** Getting errors when running crosstabs

**Solution:**
- Ensure your data file has columns named Q10_1, Q10_2, etc.
- Check that column names match exactly (case-sensitive)
- Verify Q10_othertext column exists if ShowInOutput = "Y"

---

## Important Notes

1. **Does NOT break existing code** - the Tabs module already expects:
   - Q10_1, Q10_2, etc. for multi-mention
   - The validation system already handles this correctly

2. **Backwards compatible** - if you don't have "other specify" options, 
   nothing changes from before

3. **Column names must match** - your Excel data must have columns named 
   exactly as shown in the Options sheet

4. **You can manually edit** - after generation, you can:
   - Change ShowInOutput for any row
   - Adjust which column numbers to use
   - Rename or reorganize options

---

## Version History

**v1.1.0** (Oct 2025)
- Added multi-mention individual codes (Q10_1, Q10_2, etc.)
- Added automatic other-text question generation
- Added other-text option detection
- Set ShowInOutput = "N" default for other-text

**v1.0.2** (Oct 2025)
- Fixed inline options and zero-padding

**v1.0.0** (Oct 2025)
- Initial modular release
