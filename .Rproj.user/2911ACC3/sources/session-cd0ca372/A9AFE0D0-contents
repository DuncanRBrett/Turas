#!/usr/bin/env Rscript
# ==============================================================================
# TURAS ANALYTICS TOOLKIT - BOOTSTRAP & SETUP
# ==============================================================================
# Run this script to set up the complete Turas toolkit structure
# Works on Mac, Windows3, and Linux
# ==============================================================================

#' Create the complete Turas directory structure
#' @param base_path Base directory for Turas (default: current directory)
create_turas_structure <- function(base_path = getwd()) {
  
  cat("\n")
  cat("=====================================\n")
  cat("   TURAS ANALYTICS TOOLKIT SETUP    \n")
  cat("=====================================\n\n")
  
  # Confirm location
  cat("Setting up Turas in:", base_path, "\n")
  if (interactive()) {
    cat("Continue? (y/n): ")
    if (tolower(readline()) != "y") {
      cat("Setup cancelled.\n")
      return(invisible(NULL))
    }
  }
  
  # Create directory structure
  dirs <- c(
    "core",
    "shared/statistics",
    "shared/data", 
    "shared/output",
    "modules/tabs/lib",
    "modules/tabs/templates",
    "modules/parser/lib",
    "modules/conjoint/lib",
    "modules/segment/lib",
    "projects",
    "templates/Project_Template/Data",
    "templates/Project_Template/Output",
    "docs"
  )
  
  for (dir in dirs) {
    dir_path <- file.path(base_path, dir)
    if (!dir.exists(dir_path)) {
      dir.create(dir_path, recursive = TRUE)
      cat("Created:", dir, "\n")
    }
  }
  
  cat("\nDirectory structure created\n\n")
}

#' Create the main turas.R loader file
create_turas_loader <- function(base_path = getwd()) {
  content <- '# ==============================================================================
# TURAS ANALYTICS TOOLKIT - MAIN LOADER
# ==============================================================================
# Source this file to load Turas core functionality
# ==============================================================================

# Detect Turas home directory
if (!exists("TURAS_HOME")) {
  # Try to find turas.R in parent directories
  if (file.exists("turas.R")) {
    TURAS_HOME <- getwd()
  } else if (file.exists(file.path("..", "turas.R"))) {
    TURAS_HOME <- normalizePath("..")
  } else if (file.exists(file.path("..", "..", "turas.R"))) {
    TURAS_HOME <- normalizePath(file.path("..", ".."))
  } else {
    stop("Cannot find Turas installation. Please set TURAS_HOME manually.")
  }
}

# Version information
TURAS_VERSION <- "1.0.0"
TURAS_BUILD_DATE <- "2025-01-10"

#\' Display Turas banner
turas_banner <- function() {
  cat("\\n")
  cat("=======================================\\n")
  cat("  TURAS ANALYTICS TOOLKIT v", TURAS_VERSION, "\\n", sep = "")
  cat("=======================================\\n")
  cat("\\n")
}

#\' Load Turas core modules
#\' @export
turas_load_core <- function(silent = FALSE) {
  if (!silent) cat("Loading Turas core...\\n")
  
  core_modules <- c(
    "constants.R",
    "dependencies.R",
    "logging.R",
    "validation.R",
    "utilities.R",
    "io.R",
    "platform.R"
  )
  
  for (module in core_modules) {
    module_path <- file.path(TURAS_HOME, "core", module)
    if (file.exists(module_path)) {
      source(module_path)
      if (!silent) cat("  -", module, "\\n")
    } else {
      if (!silent) cat("  x", module, "(not found)\\n")
    }
  }
  
  if (!silent) cat("\\nCore loaded\\n\\n")
}

#\' Load a specific Turas module
#\' @param module_name Name of module (e.g., "tabs", "parser")
#\' @export
turas_load <- function(module_name) {
  module_path <- file.path(TURAS_HOME, "modules", module_name)
  
  if (!dir.exists(module_path)) {
    stop(sprintf("Module \'%s\' not found", module_name))
  }
  
  cat(sprintf("Loading Turas>%s...\\n", tools::toTitleCase(module_name)))
  
  # Load module libraries
  lib_path <- file.path(module_path, "lib")
  if (dir.exists(lib_path)) {
    lib_files <- list.files(lib_path, pattern = "\\\\.R$", 
                           full.names = TRUE, ignore.case = TRUE)
    for (lib_file in lib_files) {
      source(lib_file)
      cat("  -", basename(lib_file), "\\n")
    }
  }
  
  cat(sprintf("\\nTuras>%s ready\\n\\n", tools::toTitleCase(module_name)))
}

#\' Select a project interactively
#\' @export
turas_select_project <- function() {
  projects_dir <- file.path(TURAS_HOME, "projects")
  
  if (!dir.exists(projects_dir)) {
    stop("Projects directory not found")
  }
  
  # List available projects
  projects <- list.dirs(projects_dir, full.names = FALSE, recursive = FALSE)
  projects <- projects[projects != ""]
  
  if (length(projects) == 0) {
    cat("No projects found.\\n")
    cat("Create a new project? (y/n): ")
    if (tolower(readline()) == "y") {
      return(turas_create_project())
    } else {
      return(NULL)
    }
  }
  
  # Show project menu
  cat("\\nAvailable projects:\\n")
  for (i in seq_along(projects)) {
    cat(sprintf("  %d. %s\\n", i, projects[i]))
  }
  cat("  0. Create new project\\n")
  cat("\\nSelect project (0-", length(projects), "): ", sep = "")
  
  choice <- as.integer(readline())
  
  if (choice == 0) {
    return(turas_create_project())
  } else if (choice >= 1 && choice <= length(projects)) {
    project_path <- file.path(projects_dir, projects[choice])
    cat("\\nSelected:", projects[choice], "\\n")
    return(project_path)
  } else {
    cat("Invalid selection\\n")
    return(NULL)
  }
}

#\' Create a new project
#\' @export
turas_create_project <- function() {
  cat("\\nProject name: ")
  project_name <- readline()
  
  if (project_name == "") {
    cat("Project name cannot be empty\\n")
    return(NULL)
  }
  
  # Clean project name (remove special characters)
  project_name <- gsub("[^A-Za-z0-9_-]", "_", project_name)
  
  projects_dir <- file.path(TURAS_HOME, "projects")
  project_path <- file.path(projects_dir, project_name)
  
  if (dir.exists(project_path)) {
    cat("Project already exists\\n")
    return(NULL)
  }
  
  # Create project from template
  template_path <- file.path(TURAS_HOME, "templates", "Project_Template")
  
  if (dir.exists(template_path)) {
    # Copy template structure
    dir.create(project_path, recursive = TRUE)
    file.copy(file.path(template_path, "Data"), project_path, recursive = TRUE)
    file.copy(file.path(template_path, "Output"), project_path, recursive = TRUE)
  } else {
    # Create basic structure
    dir.create(file.path(project_path, "Data"), recursive = TRUE)
    dir.create(file.path(project_path, "Output"), recursive = TRUE)
  }
  
  # Copy global templates
  templates_path <- file.path(TURAS_HOME, "templates")
  if (file.exists(file.path(templates_path, "Survey_Structure.xlsx"))) {
    file.copy(
      file.path(templates_path, "Survey_Structure.xlsx"),
      file.path(project_path, "Survey_Structure.xlsx")
    )
  }
  
  cat("\\nProject created:", project_name, "\\n")
  cat("  Path:", project_path, "\\n")
  
  return(project_path)
}

#\' Get Turas information
#\' @export
turas_info <- function() {
  turas_banner()
  cat("Home directory:", TURAS_HOME, "\\n")
  cat("R version:", paste(R.version$major, R.version$minor, sep = "."), "\\n")
  
  # List available modules
  modules_path <- file.path(TURAS_HOME, "modules")
  if (dir.exists(modules_path)) {
    modules <- list.dirs(modules_path, full.names = FALSE, recursive = FALSE)
    modules <- modules[modules != ""]
    if (length(modules) > 0) {
      cat("\\nAvailable modules:\\n")
      for (module in modules) {
        cat(sprintf("  * Turas>%s\\n", tools::toTitleCase(module)))
      }
    }
  }
  
  cat("\\n")
}

# Auto-load core on sourcing
if (!exists(".TURAS_CORE_LOADED")) {
  turas_banner()
  turas_load_core(silent = FALSE)
  .TURAS_CORE_LOADED <- TRUE
}
'
  
  writeLines(content, file.path(base_path, "turas.R"))
  cat("Created: turas.R\n")
}

#' Create core module files (placeholders)
create_core_modules <- function(base_path = getwd()) {
  
  # Create constants.R
  constants_content <- '# ==============================================================================
# TURAS CORE - CONSTANTS
# ==============================================================================

# Crosstab constants
CROSSTAB_MIN_BASE <- 30
SIGNIFICANCE_LEVELS <- c(0.10, 0.05, 0.01)

# File paths
DEFAULT_DATA_DIR <- "Data"
DEFAULT_OUTPUT_DIR <- "Output"

cat("Core constants loaded\\n")
'
  writeLines(constants_content, file.path(base_path, "core", "constants.R"))
  cat("Created: core/constants.R\n")
  
  # Create dependencies.R
  deps_content <- '# ==============================================================================
# TURAS CORE - DEPENDENCIES
# ==============================================================================

# Check for required packages
required_packages <- c("openxlsx", "dplyr", "tidyr")

for (pkg in required_packages) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    message(sprintf("Package \'%s\' not found. Install with: install.packages(\"%s\")", pkg, pkg))
  }
}

cat("Dependencies checked\\n")
'
  writeLines(deps_content, file.path(base_path, "core", "dependencies.R"))
  cat("Created: core/dependencies.R\n")
  
  # Create logging.R
  logging_content <- '# ==============================================================================
# TURAS CORE - LOGGING
# ==============================================================================

.TURAS_LOG <- new.env()
.TURAS_LOG$entries <- list()

log_message <- function(message, level = "INFO", context = NULL) {
  timestamp <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  
  cat(sprintf("[%s] %s: %s\\n", timestamp, level, message))
  
  .TURAS_LOG$entries <- append(.TURAS_LOG$entries, list(list(
    timestamp = timestamp,
    level = level,
    message = message,
    context = context
  )))
}

log_info <- function(message, context = NULL) {
  log_message(message, "INFO", context)
}

log_warning <- function(message, context = NULL) {
  log_message(message, "WARNING", context)
}

log_error <- function(message, context = NULL) {
  log_message(message, "ERROR", context)
}

cat("Logging system loaded\\n")
'
  writeLines(logging_content, file.path(base_path, "core", "logging.R"))
  cat("Created: core/logging.R\n")
  
  # Create placeholder files for other modules
  placeholder_modules <- c("validation.R", "utilities.R", "io.R", "platform.R")
  
  for (module in placeholder_modules) {
    placeholder_content <- sprintf('# ==============================================================================
# TURAS CORE - %s
# ==============================================================================
# Placeholder - will be populated during migration

cat("%s loaded\\n")
', toupper(gsub("\\.R$", "", module)), module)
    
    writeLines(placeholder_content, file.path(base_path, "core", module))
    cat("Created: core/", module, "\n", sep = "")
  }
}

#' Create initial Tabs module
create_tabs_module <- function(base_path = getwd()) {
  
  # Create run_tabs.R
  run_tabs_content <- '# ==============================================================================
# TURAS>TABS - CROSSTABULATION MODULE
# ==============================================================================
# Click "Source" in RStudio to run
# ==============================================================================

# Load Turas if not already loaded
if (!exists("TURAS_HOME")) {
  # Try to find turas.R
  search_paths <- c(
    "../..",  # If running from modules/tabs/
    "..",     # If running from modules/
    "."       # If running from Turas root
  )
  
  for (path in search_paths) {
    if (file.exists(file.path(path, "turas.R"))) {
      source(file.path(path, "turas.R"))
      break
    }
  }
  
  if (!exists("TURAS_HOME")) {
    stop("Cannot find Turas. Please run from Turas directory or set TURAS_HOME")
  }
}

# Load Tabs module
turas_load("tabs")

#\' Main entry point for Tabs analysis
run_tabs_analysis <- function(project_path = NULL) {
  
  cat("\\n")
  cat("=======================================\\n")
  cat("       TURAS>TABS ANALYSIS             \\n")
  cat("=======================================\\n\\n")
  
  # Select project if not provided
  if (is.null(project_path)) {
    project_path <- turas_select_project()
    if (is.null(project_path)) {
      cat("No project selected.\\n")
      return(invisible(NULL))
    }
  }
  
  # Set working directory to project
  old_wd <- setwd(project_path)
  on.exit(setwd(old_wd))
  
  cat("\\nProject:", basename(project_path), "\\n")
  cat("Path:", project_path, "\\n\\n")
  
  # Check for required files
  required_files <- c(
    "Survey_Structure.xlsx",
    "Tabs_Config.xlsx"
  )
  
  missing_files <- required_files[!file.exists(required_files)]
  
  if (length(missing_files) > 0) {
    cat("Missing required files:\\n")
    for (file in missing_files) {
      cat("  x", file, "\\n")
    }
    cat("\\nPlease add the required files and try again.\\n")
    return(invisible(NULL))
  }
  
  # Run analysis (placeholder - will be implemented during migration)
  cat("Loading configuration...\\n")
  cat("Loading survey structure...\\n")
  cat("Loading data...\\n")
  cat("Running crosstabulation...\\n")
  cat("Writing output...\\n")
  
  cat("\\nAnalysis complete!\\n")
  cat("Output saved to:", file.path(project_path, "Output"), "\\n\\n")
}

# Run if sourced interactively
if (interactive()) {
  run_tabs_analysis()
}
'
  
  writeLines(run_tabs_content, 
             file.path(base_path, "modules", "tabs", "run_tabs.R"))
  cat("Created: modules/tabs/run_tabs.R\n")
  
  # Create placeholder lib file
  lib_placeholder <- '# ==============================================================================
# TURAS>TABS - MODULE LIBRARIES
# ==============================================================================
# Processing functions will be migrated here

cat("Tabs libraries loaded\\n")
'
  writeLines(lib_placeholder, 
             file.path(base_path, "modules", "tabs", "lib", "processor.R"))
  cat("Created: modules/tabs/lib/processor.R\n")
}

#' Main setup function
setup_turas <- function(base_path = NULL) {
  
  # Determine installation path
  if (is.null(base_path)) {
    cat("Where should Turas be installed?\n")
    cat("1. Current directory (", getwd(), ")\n", sep = "")
    cat("2. Choose directory\n")
    cat("3. Cancel\n")
    cat("Selection (1-3): ")
    
    choice <- readline()
    
    if (choice == "1") {
      base_path <- getwd()
    } else if (choice == "2") {
      cat("Please enter the full path: ")
      base_path <- readline()
      if (!dir.exists(dirname(base_path))) {
        cat("Invalid directory path.\n")
        return(invisible(NULL))
      }
    } else {
      cat("Setup cancelled.\n")
      return(invisible(NULL))
    }
  }
  
  # Create structure
  create_turas_structure(base_path)
  
  # Create core files
  cat("Creating core files...\n")
  create_turas_loader(base_path)
  create_core_modules(base_path)
  
  # Create initial module
  cat("\nCreating Tabs module...\n")
  create_tabs_module(base_path)
  
  # Final message
  cat("\n")
  cat("=======================================\n")
  cat("    TURAS SETUP COMPLETE!             \n")
  cat("=======================================\n\n")
  
  cat("Next steps:\n")
  cat("1. Open RStudio\n")
  cat("2. Set working directory to:", base_path, "\n")
  cat("3. Run: source('turas.R')\n")
  cat("4. Start using Turas>Tabs!\n\n")
  
  cat("To run Tabs analysis:\n")
  cat("* Open: modules/tabs/run_tabs.R\n")
  cat("* Click 'Source' button\n\n")
  
  return(invisible(base_path))
}

# Run setup if executed directly
if (!interactive() || 
    (interactive() && !exists(".SKIP_AUTO_SETUP"))) {
  setup_turas()
}